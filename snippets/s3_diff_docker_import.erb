<%
base_image = "/opt/dockly/base_image.tar"
%>

s3_diff_docker_import_base_fn() {
<%= get_from_s3(data[:base_image]) %>
}

s3_diff_docker_import_diff_fn() {
<%= get_from_s3(data[:diff_image]) %>
}

stream_image() {
size=$(stat --format "%s" "<%= base_image %>")
head_size=$(($size - 1024))
head -c $head_size "<%= base_image %>"
s3_diff_docker_import_diff_fn | (gunzip -vc 2> >(log) || fatal "tardiff failed to gunzip")
}

docker_import() {
<%= docker_import(data[:repo], data[:tag]).to_s.strip %> > >(log) 2>&1 || fatal "docker failed to import"
}

s3_diff_docker_import_base_fn | gunzip -vc > "<%= base_image %>" 2> >(log)

stream_image | docker_import
