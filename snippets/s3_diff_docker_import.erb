<%
base_image = "/opt/dockly/base_image.tar"
%>

s3_diff_docker_import_base_fn() {
<%= get_from_s3(data[:base_image]) %>
}
s3_diff_docker_import_diff_fn() {
<%= get_from_s3(data[:diff_image]) %>
}
s3_diff_docker_import_base_fn | gunzip -vc > "<%= base_image %>" 2> >(log)
size=$(stat --format "%s" "<%= base_image %>")
head_size=$(($size - 1024))
tardiff_worked=1
docker_worked=1
(head -c $head_size "<%= base_image %>"; s3_diff_docker_import_diff_fn | gunzip -vc 2> >(log); echo "tardiff_worked=$?" > /opt/dockly/tardiff_worked) | <%= docker_import(data[:repo], data[:tag]).to_s.strip %> > >(log) 2>&1 && docker_worked=0
source /opt/dockly/tardiff_worked
[[ $tardiff_worked != 0 ]] && fatal "tardiff failed to gunzip: $tardiff_worked"
[[ $docker_worked != 0 ]] && fatal "docker failed to import"
